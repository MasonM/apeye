/*! JavaScript Library to Create Custom Builds For Front-End Projects - v0.3.0 - 2012-08-09
* https://github.com/gfranko/DownloadBuilder.js
* Copyright (c) 2012 Greg Franko; Licensed MIT */
(function(a){"use strict",a(window,document)})(function(a,b,c){"use strict";var d=function(a){this.options={location:a&&a.location||"local",author:a&&a.author||"",repo:a&&a.repo||"",branch:a&&a.branch||""},a&&a.cache!==c?this.options.cache=+a.cache:this.options.cache=36e5,this._create()};d.prototype={VERSION:"0.3.0",githubRateLimitUrl:"https://api.github.com/rate_limit",file:"",currentCheckbox:0,checkboxes:[],callback:function(){},_create:function(){return this.supportsFilesystem=this.fileSystemSupport(),this.github=this._isUsingGithub(),this.github.isUsing&&this._checkGithubRateLimit(),this},fileSystemSupport:function(){return a.requestFileSystem=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem,a.URL=a.URL||a.webkitURL||a.mozURL,a.storageInfo=a.storageInfo||a.webkitStorageInfo||a.mozStorageInfo,!a.requestFileSystem||!a.Blob||!a.URL||!a.storageInfo?!1:!0},_isUsingGithub:function(){var a=b.querySelectorAll('[data-location="github"]');return a.length||this.options.location==="github"?{isUsing:!0,length:a.length}:{isUsing:!1,length:a.length}},_checkGithubRateLimit:function(){var a=this;return this.JSONP(this.githubRateLimitUrl,function(b){a.rateLimit=b.data.rate.remaining}),this},JSONP:function(d,e,f){d=d||"",e=e||"",f=f||function(){};var g,h;typeof e=="function"&&(f=e,e="callback"),h="jsonp"+Math.round(Math.random()*1000001),a[h]=function(b){f(b);try{delete a[h]}catch(d){a[h]=c}},d.indexOf("?")===-1?d=d+"?":d=d+"&",g=b.createElement("script"),g.setAttribute("src",d+e+"="+h),b.getElementsByTagName("head")[0].appendChild(g)},buildURL:function(b,c,d,e){if(b.length){var f=this,g=(new Date).getTime(),h,i,j,k,l,m,n,o;typeof e=="function"&&(f.callback=e),f.currentCheckbox===0&&a.sessionStorage&&!a.sessionStorage.getItem("cache-time")&&a.sessionStorage.setItem("cache-time",g),f.checkboxes=b,o=f.currentCheckbox===b.length-1||!1,h=b[f.currentCheckbox],i=h.getAttribute("data-location")||f.options.location||"",j=h.getAttribute("data-author")||f.options.author||"",k=h.getAttribute("data-repo")||f.options.repo||"",l=h.getAttribute("data-branch")||f.options.branch||"",m=h.getAttribute("data-localpath")||"",a.sessionStorage&&(a.sessionStorage.getItem(h.value)&&a.sessionStorage.getItem("cache-time")?g-a.sessionStorage.getItem("cache-time")>=f.options.cache?(a.sessionStorage.removeItem(h.value),a.sessionStorage.removeItem("cache-time"),f._sendRequest({location:i,repoAuthor:j,repoName:k,repoBranch:l,localPath:m,currentElem:h,time:g,lastElem:o,fileName:c,lang:d})):(f.file+=a.sessionStorage.getItem(h.value),f._fileStatus({lastElem:o,lang:d,fileName:c})):f._sendRequest({location:i,repoAuthor:j,repoName:k,repoBranch:l,localPath:m,currentElem:h,time:g,lastElem:o,fileName:c,lang:d}))}else e.call(a,{content:"",fileName:c,lang:d});return this},_localRequest:function(b){var c=this,d,e;try{d=new XMLHttpRequest,d.open("GET",b.url,!0),d.onreadystatechange=function(d){this.readyState===4&&this.status===200&&(e=this.responseText||this.response||"",c.file+=e,a.sessionStorage.setItem(b.elem.value,e||""),c._fileStatus({lastElem:b.lastElem,lang:b.lang,fileName:b.fileName}))},d.send()}catch(f){}return this},_thirdPartyRequest:function(b){var c=this,d;this.JSONP(b.url,function(e){b.type==="github"&&(d=c._parseGithubResponse({elem:b.elem,data:e})||"",c.file+=d,a.sessionStorage.setItem(b.elem.value,d||""),c._fileStatus({lastElem:b.lastElem,lang:b.lang,fileName:b.fileName}))})},_sendRequest:function(a){a.location==="github"?this.rateLimit!==0?(this.rateLimit-=1,this._thirdPartyRequest({type:a.location,url:"https://api.github.com/repos/"+a.repoAuthor+"/"+a.repoName+"/contents/?ref="+a.repoBranch+"&path="+a.currentElem.value,elem:a.currentElem,time:a.time,lastElem:a.lastElem,lang:a.lang,fileName:a.fileName})):a.localPath&&this._localRequest({url:a.localpath,elem:a.currentElem,time:a.time,lastElem:a.lastElem,lang:a.lang,fileName:a.fileName}):this._localRequest({url:a.currentElem.value,elem:a.currentElem,time:a.time,lastElem:a.lastElem,lang:a.lang,fileName:a.fileName})},_parseGithubResponse:function(b){var d=this,e,f,g,h;return b.data.data.content!==c&&a.atob&&b.data.data.encoding==="base64"&&(e=b.data.data.content,e=e.replace(/\n/g,""),f=a.atob(e),g=f.split("\n"),h=g.slice(0,g.length).join("\n")||""),h},createURL:function(b){var c=this,d;return a.storageInfo.requestQuota(a.TEMPORARY,1048576,function(e){a.requestFileSystem(c.storageType,e,function(c){c.root.getFile(b.fileName,{create:!0},function(c){c.createWriter(function(c){d=new a.Blob([b.data],{type:"text/"+b.lang}),b.callback.call(a,a.URL.createObjectURL(d))})})})}),this},_fileStatus:function(b){var c=this,d;return b.lastElem?(this.currentCheckbox=0,c.supportsFilesystem?c.createURL({lang:b.lang,fileName:b.fileName,data:c.file,callback:function(d){a.sessionStorage.setItem("bloburl",d),c.callback.call(a,{url:d,content:c.file,fileName:b.fileName,lang:b.lang}),c.file=""}}):(c.callback.call(a,{content:c.file,fileName:b.fileName,lang:b.lang}),c.file="")):(this.currentCheckbox+=1,c.buildURL(c.checkboxes,b.fileName,b.lang,c.callback)),this}},a.DownloadBuilder=d});